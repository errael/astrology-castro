#!/bin/bash

CMD=${0##*/}
DIR=${0%/*}

. $DIR/COMMON

set -e

if [[ -z "$1" ]]
then
    echo "Must specify tag: v7.70 or v7.60" >&2
    exit 1
fi

hg up -q -R $ASTROLOG_ROOT $1

ver_tag=$(hg log -R $ASTROLOG_ROOT -r . -T"{tags % '{tag}\n'}" | grep '^v')
if [[ "$ver_tag" == "v7.70" ]] 
then
    SRC_TAG=770
elif [[ "$ver_tag" == "v7.60" ]]
then
    SRC_TAG=760
else
    {
        echo 
        echo "VERSION TAG NOT FOUND"
        echo 
        hg log -R $ASTROLOG_ROOT -r .
    } >&2
    exit 1
fi

#echo $SRC_TAG

exit_msg() {
    echo "target: $CASTRO_TABLES/AstrologKeyCodes_$SRC_TAG.java" >&2
}

extract() {
    awk -f \
        $DIR/extract_win_keycodes.gawk \
        $ASTROLOG_ROOT/resource.h $ASTROLOG_ROOT/astrolog.rc
}

cat <<CODE
// This file is generated by a script, scipts/extract_win_keycodes,
// from astrolog's "resource.h" and "astrolog.rc" which is copyrighted by:
// Walter D. Pullen (Astara@msn.com, http://www.astrolog.org/astrolog.htm)

package com.raelity.astrolog.castro.tables;

import java.util.EnumSet;
import java.util.Map;

import static com.raelity.astrolog.castro.tables.AstrologKeyCodes.Modifier.*;

public class AstrologKeyCodes_${SRC_TAG} extends AstrologKeyCodes
{
@Override
final void createEntries(Map<Stroke, Integer> codes)
{
CODE

extract

cat <<"CODE"
}

}
CODE

exit_msg
